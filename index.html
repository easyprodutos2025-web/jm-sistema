<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JM TECNOLOGIA Use Cases</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, getDoc, runTransaction, setDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';

        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCNCheV1ezBEcilueuGuWM9FF4Pn8pBhXo",
            authDomain: "jm-tecnologia-use-cases.firebaseapp.com",
            projectId: "jm-tecnologia-use-cases",
            storageBucket: "jm-tecnologia-use-cases.firebasestorage.app",
            messagingSenderId: "1039370626796",
            appId: "1:1039370626796:web:db89f13b918d377e6667c9",
            measurementId: "G-EJQNDRXELH"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const storage = getStorage(app);

        // Disponibilizar globalmente
        window.db = db;
        window.auth = auth;
        window.storage = storage;
        window.firebaseModules = {
            collection, addDoc, getDocs, doc, updateDoc, deleteDoc, getDoc, runTransaction, setDoc,
            signInWithEmailAndPassword, signOut, onAuthStateChanged,
            ref, uploadBytes, getDownloadURL, deleteObject
        };
    </script>

    <!-- Google AI SDK -->
    <script type="importmap">
        {
            "imports": {
                "@google/generative-ai": "https://esm.run/@google/generative-ai"
            }
        }
    </script>

    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docx/7.1.0/docx.min.js"></script>

    <style>
        :root {
            --primary-color: #0066ff;
            --secondary-color: #00ccff;
            --accent-color: #ff6b35;
            --success-color: #00ff88;
            --warning-color: #ffaa00;
            --error-color: #ff4757;
            --bg-primary: #0a0a0a;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #2a2a2a;
            --text-primary: #ffffff;
            --text-secondary: #cccccc;
            --text-muted: #888888;
            --border-color: #333333;
            --shadow-color: rgba(0, 102, 255, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Animated Background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(0, 102, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(0, 204, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(255, 107, 53, 0.1) 0%, transparent 50%);
            z-index: -1;
            animation: backgroundMove 20s ease-in-out infinite;
        }

        @keyframes backgroundMove {
            0%, 100% { transform: translateX(0) translateY(0); }
            33% { transform: translateX(-20px) translateY(-20px); }
            66% { transform: translateX(20px) translateY(-10px); }
        }

        /* Header */
        .header {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .logo i {
            font-size: 2rem;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.1);
            font-size: 0.9rem;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-online { background: var(--success-color); }
        .status-offline { background: var(--error-color); }
        .status-connecting { background: var(--warning-color); }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logout-btn {
            background: linear-gradient(135deg, var(--error-color), #ff6b6b);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 71, 87, 0.4);
        }

        /* Login Screen */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .login-container {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 3rem;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .login-title {
            font-size: 2rem;
            margin-bottom: 2rem;
            color: var(--text-primary);
        }

        .form-group {
            margin-bottom: 1.5rem;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .form-control {
            width: 100%;
            padding: 1rem;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 20px rgba(0, 102, 255, 0.3);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            width: 100%;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 102, 255, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Main Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 2rem;
            min-height: calc(100vh - 100px);
        }

        .main-content {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }

        .sidebar {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            height: fit-content;
            position: sticky;
            top: 120px;
        }

        /* Navigation */
        .nav-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            border-bottom: 1px solid var(--border-color);
        }

        .nav-tab {
            padding: 1rem 1.5rem;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 10px 10px 0 0;
            transition: all 0.3s ease;
            font-size: 1rem;
            font-weight: 600;
            position: relative;
        }

        .nav-tab.active {
            color: var(--primary-color);
            background: rgba(0, 102, 255, 0.1);
        }

        .nav-tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        }

        .nav-tab:hover {
            color: var(--primary-color);
            background: rgba(0, 102, 255, 0.05);
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Form Styles */
        .form-section {
            margin-bottom: 2rem;
        }

        .form-section h3 {
            color: var(--primary-color);
            margin-bottom: 1rem;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-row.full {
            grid-template-columns: 1fr;
        }

        textarea.form-control {
            min-height: 120px;
            resize: vertical;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: var(--primary-color);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-color), #00cc70);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 255, 136, 0.4);
        }

        /* Subtasks */
        .subtasks-container {
            margin-top: 1rem;
        }

        .subtask-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            position: relative;
        }

        .subtask-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .subtask-code {
            font-weight: 600;
            color: var(--secondary-color);
        }

        .remove-subtask {
            background: var(--error-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        .remove-subtask:hover {
            transform: scale(1.1);
        }

        /* File Upload */
        .file-upload-area {
            border: 2px dashed var(--border-color);
            border-radius: 10px;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            margin-bottom: 1rem;
        }

        .file-upload-area:hover,
        .file-upload-area.dragover {
            border-color: var(--primary-color);
            background: rgba(0, 102, 255, 0.05);
        }

        .file-list {
            margin-top: 1rem;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
            margin-bottom: 0.5rem;
        }

        .file-name {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .remove-file {
            background: var(--error-color);
            color: white;
            border: none;
            border-radius: 3px;
            padding: 0.2rem 0.5rem;
            cursor: pointer;
            font-size: 0.8rem;
        }

        /* Documents List */
        .documents-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .search-filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .search-input {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        .filter-select {
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            min-width: 150px;
        }

        .documents-grid {
            display: grid;
            gap: 1rem;
        }

        .document-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 15px;
            padding: 1.5rem;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .document-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 102, 255, 0.2);
            border-color: var(--primary-color);
        }

        .document-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .document-code {
            font-weight: 700;
            color: var(--primary-color);
            font-size: 1.1rem;
        }

        .document-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .document-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-bottom: 1rem;
        }

        .document-description {
            color: var(--text-secondary);
            line-height: 1.5;
            margin-bottom: 1rem;
        }

        .document-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-icon {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            border-radius: 8px;
            padding: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .btn-icon:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .btn-icon.danger:hover {
            background: var(--error-color);
            border-color: var(--error-color);
        }

        /* Status Badge */
        .status-badge {
            padding: 0.3rem 0.8rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-ativo {
            background: rgba(0, 255, 136, 0.2);
            color: var(--success-color);
        }

        .status-inativo {
            background: rgba(255, 170, 0, 0.2);
            color: var(--warning-color);
        }

        .status-concluido {
            background: rgba(0, 102, 255, 0.2);
            color: var(--primary-color);
        }

        /* Export Section */
        .export-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .export-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
        }

        .export-btn {
            background: linear-gradient(135deg, var(--accent-color), #ff8c42);
            color: white;
            border: none;
            padding: 1rem;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }

        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(255, 107, 53, 0.4);
        }

        /* Mariano Assistant */
        .mariano-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .mariano-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .mariano-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }

        .mariano-content {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            min-height: 100px;
        }

        .mariano-input-group {
            display: flex;
            gap: 0.5rem;
        }

        .mariano-input {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        .ask-mariano-btn {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .ask-mariano-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 102, 255, 0.4);
        }

        /* AI Assistant */
        .ai-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .ai-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .ai-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff6b35, #f7931e);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }

        .ai-content {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            min-height: 100px;
            max-height: 300px;
            overflow-y: auto;
        }

        .ai-input-group {
            display: flex;
            gap: 0.5rem;
        }

        .ai-input {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        .ask-ai-btn {
            background: linear-gradient(135deg, #ff6b35, #f7931e);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .ask-ai-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 53, 0.4);
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            z-index: 3000;
            animation: slideIn 0.3s ease;
            max-width: 400px;
        }

        .notification.success {
            background: linear-gradient(135deg, var(--success-color), #00cc70);
        }

        .notification.error {
            background: linear-gradient(135deg, var(--error-color), #ff6b6b);
        }

        .notification.warning {
            background: linear-gradient(135deg, var(--warning-color), #ffcc02);
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Loading Spinner */
        .loading {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-muted);
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-top: 2px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
                padding: 1rem;
            }

            .header-content {
                flex-direction: column;
                gap: 1rem;
            }

            .nav-tabs {
                flex-wrap: wrap;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .search-filters {
                flex-direction: column;
            }

            .export-buttons {
                grid-template-columns: 1fr 1fr;
            }
        }

        /* Hidden class */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-screen">
        <div class="login-container">
            <div class="logo">
                <i class="fas fa-clipboard-list"></i>
                <span>JM TECNOLOGIA</span>
            </div>
            <h2 class="login-title">Acesso ao Sistema</h2>
            <form id="loginForm">
                <div class="form-group">
                    <label for="loginEmail">Email</label>
                    <input type="email" id="loginEmail" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="loginPassword">Senha</label>
                    <input type="password" id="loginPassword" class="form-control" required>
                </div>
                <button type="submit" class="btn-primary" id="loginBtn">
                    <i class="fas fa-sign-in-alt"></i>
                    Entrar
                </button>
            </form>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="hidden">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-clipboard-list"></i>
                    <span>JM TECNOLOGIA</span>
                </div>
                <div class="header-actions">
                    <div class="connection-status">
                        <div class="status-indicator" id="statusIndicator"></div>
                        <span id="statusText">Conectando...</span>
                    </div>
                    <div class="user-info">
                        <span id="userEmail"></span>
                        <button class="logout-btn" onclick="logout()">
                            <i class="fas fa-sign-out-alt"></i>
                            Sair
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Container -->
        <div class="container">
            <!-- Main Content -->
            <div class="main-content">
                <!-- Navigation Tabs -->
                <div class="nav-tabs">
                    <button class="nav-tab active" onclick="showTab('create')">
                        <i class="fas fa-plus"></i> Criar
                    </button>
                    <button class="nav-tab" onclick="showTab('list')">
                        <i class="fas fa-list"></i> Documentos
                    </button>
                    <button class="nav-tab" onclick="showTab('export')">
                        <i class="fas fa-download"></i> Exportar
                    </button>
                </div>

                <!-- Create Tab -->
                <div id="createTab" class="tab-content active">
                    <form id="documentForm">
                        <!-- Basic Information -->
                        <div class="form-section">
                            <h3><i class="fas fa-info-circle"></i> Informações Básicas</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="codigo">Código (Automático)</label>
                                    <input type="text" id="codigo" class="form-control" readonly>
                                </div>
                                <div class="form-group">
                                    <label for="status">Status</label>
                                    <select id="status" class="form-control">
                                        <option value="Ativo">Ativo</option>
                                        <option value="Inativo">Inativo</option>
                                        <option value="Concluído">Concluído</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row full">
                                <div class="form-group">
                                    <label for="titulo">Título</label>
                                    <input type="text" id="titulo" class="form-control" placeholder="Digite o título do caso de uso">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="autor">Autor</label>
                                    <input type="text" id="autor" class="form-control" placeholder="Nome do autor">
                                </div>
                                <div class="form-group">
                                    <label for="responsavel">Responsável</label>
                                    <input type="text" id="responsavel" class="form-control" placeholder="Nome do responsável">
                                </div>
                            </div>
                        </div>

                        <!-- Description -->
                        <div class="form-section">
                            <h3><i class="fas fa-align-left"></i> Descrição</h3>
                            <div class="form-row full">
                                <div class="form-group">
                                    <label for="descricao">Descrição do Caso de Uso</label>
                                    <textarea id="descricao" class="form-control" placeholder="Descreva o objetivo e contexto do caso de uso"></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Problem and Solution -->
                        <div class="form-section">
                            <h3><i class="fas fa-lightbulb"></i> Problema e Solução</h3>
                            <div class="form-row full">
                                <div class="form-group">
                                    <label for="problema">Problema</label>
                                    <textarea id="problema" class="form-control" placeholder="Descreva o problema que este caso de uso resolve"></textarea>
                                </div>
                            </div>
                            <div class="form-row full">
                                <div class="form-group">
                                    <label for="solucao">Solução</label>
                                    <textarea id="solucao" class="form-control" placeholder="Descreva a solução proposta"></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Subtasks -->
                        <div class="form-section">
                            <h3><i class="fas fa-tasks"></i> Subtarefas</h3>
                            <button type="button" class="btn-secondary" onclick="addSubtask()">
                                <i class="fas fa-plus"></i> Adicionar Subtarefa
                            </button>
                            <div id="subtasksContainer" class="subtasks-container"></div>
                        </div>

                        <!-- File Attachments -->
                        <div class="form-section">
                            <h3><i class="fas fa-paperclip"></i> Anexos</h3>
                            <div class="file-upload-area" id="fileUploadArea">
                                <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; color: var(--text-muted); margin-bottom: 1rem;"></i>
                                <p>Arraste arquivos aqui ou clique para selecionar</p>
                                <p style="font-size: 0.9rem; color: var(--text-muted);">Formatos: PDF, DOC, DOCX, XLS, XLSX, PNG, JPG (máx. 10MB)</p>
                            </div>
                            <input type="file" id="fileInput" multiple accept=".pdf,.doc,.docx,.xls,.xlsx,.png,.jpg,.jpeg" style="display: none;">
                            <div id="fileList" class="file-list"></div>
                        </div>

                        <!-- Actions -->
                        <div class="form-section">
                            <button type="submit" class="btn-success">
                                <i class="fas fa-save"></i> Salvar Documento
                            </button>
                        </div>
                    </form>
                </div>

                <!-- List Tab -->
                <div id="listTab" class="tab-content">
                    <div class="documents-header">
                        <h2>Documentos Cadastrados</h2>
                        <button class="btn-primary" onclick="loadDocuments()">
                            <i class="fas fa-sync"></i> Atualizar
                        </button>
                    </div>

                    <div class="search-filters">
                        <input type="text" id="searchInput" class="search-input" placeholder="Buscar por título, código, autor...">
                        <select id="statusFilter" class="filter-select">
                            <option value="">Todos os Status</option>
                            <option value="Ativo">Ativo</option>
                            <option value="Inativo">Inativo</option>
                            <option value="Concluído">Concluído</option>
                        </select>
                    </div>

                    <div id="documentsGrid" class="documents-grid">
                        <!-- Documents will be loaded here -->
                    </div>
                </div>

                <!-- Export Tab -->
                <div id="exportTab" class="tab-content">
                    <div class="export-section">
                        <h3><i class="fas fa-download"></i> Exportar Documentos</h3>
                        <p>Exporte todos os documentos em diferentes formatos:</p>
                        <div class="export-buttons">
                            <button class="export-btn" onclick="exportToPDF()">
                                <i class="fas fa-file-pdf"></i>
                                PDF
                            </button>
                            <button class="export-btn" onclick="exportToExcel()">
                                <i class="fas fa-file-excel"></i>
                                Excel
                            </button>
                            <button class="export-btn" onclick="exportToWord()">
                                <i class="fas fa-file-word"></i>
                                Word
                            </button>
                            <button class="export-btn" onclick="exportToJSON()">
                                <i class="fas fa-file-code"></i>
                                JSON
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="sidebar">
                <!-- Mariano Assistant -->
                <div class="mariano-section">
                    <div class="mariano-header">
                        <div class="mariano-avatar">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div>
                            <h3>Mariano</h3>
                            <p style="font-size: 0.9rem; color: var(--text-muted);">Seu assistente para casos de uso</p>
                        </div>
                    </div>
                    <div class="mariano-content">
                        <p>Olá! Sou o Mariano, seu assistente para casos de uso. Como posso ajudar você hoje?</p>
                    </div>
                    <div class="mariano-input-group">
                        <input type="text" id="marianoInput" class="mariano-input" placeholder="Faça uma pergunta...">
                        <button class="ask-mariano-btn" onclick="askMariano()">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>

                <!-- AI Assistant -->
                <div class="ai-section">
                    <div class="ai-header">
                        <div class="ai-avatar">
                            <i class="fas fa-brain"></i>
                        </div>
                        <div>
                            <h3>Assistente IA</h3>
                            <p style="font-size: 0.9rem; color: var(--text-muted);">Powered by Gemini</p>
                        </div>
                    </div>
                    <div class="ai-content" id="aiContent">
                        <p>Olá! Sou seu assistente de IA. Posso ajudar você a criar casos de uso mais detalhados, sugerir melhorias e responder perguntas técnicas.</p>
                    </div>
                    <div class="ai-input-group">
                        <input type="text" id="aiInput" class="ai-input" placeholder="Pergunte algo sobre seu caso de uso...">
                        <button class="ask-ai-btn" onclick="askAI()" id="askAIBtn">
                            <i class="fas fa-magic"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";

        // Global variables
        let documents = [];
        let subtaskCounter = 0;
        let uploadedFiles = [];
        let currentUser = null;
        let genAI = null;

        // Initialize Gemini AI
        try {
            genAI = new GoogleGenerativeAI('AIzaSyBJqssqp4_4rLOvbhgbzI-Zt8Zt8Zt8Zt8'); // Replace with your API key
        } catch (error) {
            console.log('Gemini AI not available:', error);
        }

        // Authorized emails
        const authorizedEmails = [
            'josimar@jmtecnologia.com.br',
            'admin@jmtecnologia.com.br',
            'suporte@jmtecnologia.com.br'
        ];

        // Authentication
        window.auth.onAuthStateChanged((user) => {
            if (user && authorizedEmails.includes(user.email)) {
                currentUser = user;
                document.getElementById('userEmail').textContent = user.email;
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                initializeApp();
            } else {
                if (user) {
                    showNotification('Email não autorizado para acesso ao sistema', 'error');
                    logout();
                } else {
                    document.getElementById('loginScreen').classList.remove('hidden');
                    document.getElementById('mainApp').classList.add('hidden');
                }
            }
        });

        // Login form
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const loginBtn = document.getElementById('loginBtn');

            loginBtn.disabled = true;
            loginBtn.innerHTML = '<div class="spinner"></div> Entrando...';

            try {
                await window.firebaseModules.signInWithEmailAndPassword(window.auth, email, password);
            } catch (error) {
                console.error('Login error:', error);
                showNotification('Erro no login: ' + error.message, 'error');
            } finally {
                loginBtn.disabled = false;
                loginBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Entrar';
            }
        });

        // Logout function
        window.logout = async function() {
            try {
                await window.firebaseModules.signOut(window.auth);
                showNotification('Logout realizado com sucesso', 'success');
            } catch (error) {
                console.error('Logout error:', error);
                showNotification('Erro no logout', 'error');
            }
        };

        // Initialize application
        function initializeApp() {
            updateConnectionStatus('connecting');
            generateNextCode();
            initFileUpload();
            
            // Test Firebase connection
            window.firebaseModules.getDocs(window.firebaseModules.collection(window.db, 'documentos'))
                .then(() => {
                    updateConnectionStatus('online');
                    showNotification('Sistema conectado com sucesso!', 'success');
                })
                .catch((error) => {
                    console.error('Connection error:', error);
                    updateConnectionStatus('offline');
                    showNotification('Erro de conexão com Firebase', 'error');
                });
        }

        // Connection status
        function updateConnectionStatus(status) {
            const indicator = document.getElementById('statusIndicator');
            const text = document.getElementById('statusText');
            
            indicator.className = 'status-indicator status-' + status;
            
            switch(status) {
                case 'online':
                    text.textContent = 'Online';
                    break;
                case 'offline':
                    text.textContent = 'Offline';
                    break;
                case 'connecting':
                    text.textContent = 'Conectando...';
                    break;
            }
        }

        // Tab navigation
        window.showTab = function(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all nav tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // Add active class to clicked nav tab
            event.target.classList.add('active');
            
            // Load documents if list tab is selected
            if (tabName === 'list') {
                loadDocuments();
            }
        };

        // Generate next code
        async function generateNextCode() {
            try {
                const counterDoc = await window.firebaseModules.getDoc(
                    window.firebaseModules.doc(window.db, 'counters', 'documentos')
                );
                
                let nextNumber = 1;
                if (counterDoc.exists()) {
                    nextNumber = counterDoc.data().count + 1;
                }
                
                document.getElementById('codigo').value = `UC-${String(nextNumber).padStart(3, '0')}`;
            } catch (error) {
                console.error('Error generating code:', error);
                document.getElementById('codigo').value = 'UC-001';
            }
        }

        // Subtasks management
        window.addSubtask = function() {
            subtaskCounter++;
            const container = document.getElementById('subtasksContainer');
            const mainCode = document.getElementById('codigo').value;
            const subtaskCode = `${mainCode}.${subtaskCounter}`;
            
            const subtaskDiv = document.createElement('div');
            subtaskDiv.className = 'subtask-item';
            subtaskDiv.innerHTML = `
                <div class="subtask-header">
                    <span class="subtask-code">${subtaskCode}</span>
                    <button type="button" class="remove-subtask" onclick="removeSubtask(this)">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="form-group">
                    <label>Título da Subtarefa</label>
                    <input type="text" class="form-control subtask-title" placeholder="Digite o título da subtarefa">
                </div>
                <div class="form-group">
                    <label>Descrição da Subtarefa</label>
                    <textarea class="form-control subtask-description" placeholder="Descreva a subtarefa"></textarea>
                </div>
            `;
            
            container.appendChild(subtaskDiv);
        };

        window.removeSubtask = function(button) {
            button.closest('.subtask-item').remove();
        };

        // File upload
        function initFileUpload() {
            const uploadArea = document.getElementById('fileUploadArea');
            const fileInput = document.getElementById('fileInput');
            
            uploadArea.addEventListener('click', () => fileInput.click());
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                handleFiles(e.dataTransfer.files);
            });
            
            fileInput.addEventListener('change', (e) => {
                handleFiles(e.target.files);
            });
        }

        function handleFiles(files) {
            Array.from(files).forEach(file => {
                if (file.size > 10 * 1024 * 1024) {
                    showNotification(`Arquivo ${file.name} é muito grande (máx. 10MB)`, 'error');
                    return;
                }
                
                uploadedFiles.push(file);
                displayFile(file);
            });
        }

        function displayFile(file) {
            const fileList = document.getElementById('fileList');
            const fileDiv = document.createElement('div');
            fileDiv.className = 'file-item';
            fileDiv.innerHTML = `
                <span class="file-name">
                    <i class="fas fa-file"></i> ${file.name} (${formatFileSize(file.size)})
                </span>
                <button type="button" class="remove-file" onclick="removeFile('${file.name}')">
                    <i class="fas fa-times"></i>
                </button>
            `;
            fileList.appendChild(fileDiv);
        }

        window.removeFile = function(fileName) {
            uploadedFiles = uploadedFiles.filter(file => file.name !== fileName);
            const fileItems = document.querySelectorAll('.file-item');
            fileItems.forEach(item => {
                if (item.querySelector('.file-name').textContent.includes(fileName)) {
                    item.remove();
                }
            });
        };

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Document form submission
        document.getElementById('documentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                codigo: document.getElementById('codigo').value,
                titulo: document.getElementById('titulo').value,
                autor: document.getElementById('autor').value,
                responsavel: document.getElementById('responsavel').value,
                descricao: document.getElementById('descricao').value,
                problema: document.getElementById('problema').value,
                solucao: document.getElementById('solucao').value,
                status: document.getElementById('status').value,
                dataCriacao: new Date(),
                subtarefas: [],
                anexos: []
            };

            // Collect subtasks
            const subtaskItems = document.querySelectorAll('.subtask-item');
            subtaskItems.forEach((item, index) => {
                const title = item.querySelector('.subtask-title').value;
                const description = item.querySelector('.subtask-description').value;
                if (title || description) {
                    formData.subtarefas.push({
                        codigo: `${formData.codigo}.${index + 1}`,
                        titulo: title,
                        descricao: description
                    });
                }
            });

            try {
                // Upload files to Firebase Storage
                for (const file of uploadedFiles) {
                    const storageRef = window.firebaseModules.ref(window.storage, `anexos/${formData.codigo}/${file.name}`);
                    const snapshot = await window.firebaseModules.uploadBytes(storageRef, file);
                    const downloadURL = await window.firebaseModules.getDownloadURL(snapshot.ref);
                    
                    formData.anexos.push({
                        nome: file.name,
                        url: downloadURL,
                        tamanho: file.size,
                        tipo: file.type
                    });
                }

                // Save document to Firestore
                await window.firebaseModules.addDoc(
                    window.firebaseModules.collection(window.db, 'documentos'),
                    formData
                );

                // Update counter
                const counterRef = window.firebaseModules.doc(window.db, 'counters', 'documentos');
                await window.firebaseModules.runTransaction(window.db, async (transaction) => {
                    const counterDoc = await transaction.get(counterRef);
                    const newCount = counterDoc.exists() ? counterDoc.data().count + 1 : 1;
                    transaction.set(counterRef, { count: newCount });
                });

                showNotification('Documento salvo com sucesso!', 'success');
                resetForm();
                generateNextCode();
                
            } catch (error) {
                console.error('Error saving document:', error);
                showNotification('Erro ao salvar documento', 'error');
            }
        });

        // Reset form
        function resetForm() {
            document.getElementById('documentForm').reset();
            document.getElementById('subtasksContainer').innerHTML = '';
            document.getElementById('fileList').innerHTML = '';
            uploadedFiles = [];
            subtaskCounter = 0;
            document.getElementById('status').value = 'Ativo';
        }

        // Load documents
        window.loadDocuments = async function() {
            try {
                const querySnapshot = await window.firebaseModules.getDocs(
                    window.firebaseModules.collection(window.db, 'documentos')
                );
                
                documents = [];
                querySnapshot.forEach((doc) => {
                    documents.push({ id: doc.id, ...doc.data() });
                });
                
                // Sort by code
                documents.sort((a, b) => a.codigo.localeCompare(b.codigo));
                
                displayDocuments(documents);
                showNotification(`${documents.length} documentos carregados`, 'success');
                
            } catch (error) {
                console.error('Error loading documents:', error);
                showNotification('Erro ao carregar documentos', 'error');
            }
        };

        // Display documents
        function displayDocuments(docs) {
            const grid = document.getElementById('documentsGrid');
            
            if (docs.length === 0) {
                grid.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 2rem;">Nenhum documento encontrado</p>';
                return;
            }
            
            grid.innerHTML = docs.map(doc => `
                <div class="document-card">
                    <div class="document-header">
                        <div>
                            <div class="document-code">${doc.codigo}</div>
                            <div class="document-title">${doc.titulo || 'Sem título'}</div>
                        </div>
                        <div class="status-badge status-${doc.status?.toLowerCase() || 'ativo'}">
                            ${doc.status || 'Ativo'}
                        </div>
                    </div>
                    <div class="document-meta">
                        <span><i class="fas fa-user"></i> ${doc.autor || 'N/A'}</span>
                        <span><i class="fas fa-calendar"></i> ${formatDate(doc.dataCriacao)}</span>
                        ${doc.subtarefas?.length ? `<span><i class="fas fa-tasks"></i> ${doc.subtarefas.length} subtarefas</span>` : ''}
                        ${doc.anexos?.length ? `<span><i class="fas fa-paperclip"></i> ${doc.anexos.length} anexos</span>` : ''}
                    </div>
                    <div class="document-description">
                        ${doc.descricao || 'Sem descrição'}
                    </div>
                    <div class="document-actions">
                        <button class="btn-icon" onclick="editDocument('${doc.id}')" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-icon" onclick="viewDocument('${doc.id}')" title="Visualizar">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn-icon danger" onclick="deleteDocument('${doc.id}')" title="Excluir">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Document actions
        window.editDocument = function(docId) {
            const doc = documents.find(d => d.id === docId);
            if (!doc) return;
            
            // Fill form with document data
            document.getElementById('codigo').value = doc.codigo;
            document.getElementById('titulo').value = doc.titulo || '';
            document.getElementById('autor').value = doc.autor || '';
            document.getElementById('responsavel').value = doc.responsavel || '';
            document.getElementById('descricao').value = doc.descricao || '';
            document.getElementById('problema').value = doc.problema || '';
            document.getElementById('solucao').value = doc.solucao || '';
            document.getElementById('status').value = doc.status || 'Ativo';
            
            // Load subtasks
            if (doc.subtarefas) {
                doc.subtarefas.forEach(subtask => {
                    addSubtask();
                    const lastSubtask = document.querySelector('.subtask-item:last-child');
                    lastSubtask.querySelector('.subtask-title').value = subtask.titulo || '';
                    lastSubtask.querySelector('.subtask-description').value = subtask.descricao || '';
                });
            }
            
            showTab('create');
            showNotification('Documento carregado para edição', 'success');
        };

        window.viewDocument = function(docId) {
            const doc = documents.find(d => d.id === docId);
            if (!doc) return;
            
            // Create a detailed view (you can implement a modal or new page)
            alert(`Documento: ${doc.codigo}\nTítulo: ${doc.titulo}\nDescrição: ${doc.descricao}`);
        };

        window.deleteDocument = async function(docId) {
            const password = prompt('Digite a senha de segurança para excluir:');
            if (!password) return;
            
            if (!password.toLowerCase().startsWith('josimar')) {
                showNotification('Senha incorreta', 'error');
                return;
            }
            
            if (!confirm('Tem certeza que deseja excluir este documento? Esta ação não pode ser desfeita.')) {
                return;
            }
            
            try {
                await window.firebaseModules.deleteDoc(
                    window.firebaseModules.doc(window.db, 'documentos', docId)
                );
                showNotification('Documento excluído com sucesso', 'success');
                loadDocuments();
            } catch (error) {
                console.error('Error deleting document:', error);
                showNotification('Erro ao excluir documento', 'error');
            }
        };

        // Search and Filter Functions
        document.getElementById('searchInput').addEventListener('input', filterDocuments);
        document.getElementById('statusFilter').addEventListener('change', filterDocuments);

        function filterDocuments() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            
            let filteredDocs = documents.filter(doc => {
                const matchesSearch = !searchTerm || 
                    doc.titulo?.toLowerCase().includes(searchTerm) ||
                    doc.codigo?.toLowerCase().includes(searchTerm) ||
                    doc.autor?.toLowerCase().includes(searchTerm) ||
                    doc.descricao?.toLowerCase().includes(searchTerm);
                
                const matchesStatus = !statusFilter || doc.status === statusFilter;
                
                return matchesSearch && matchesStatus;
            });
            
            displayDocuments(filteredDocs);
        }

        // Export Functions
        window.exportToPDF = function() {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                doc.setFontSize(20);
                doc.text('JM TECNOLOGIA - Casos de Uso', 20, 30);
                
                let yPosition = 50;
                documents.forEach((document, index) => {
                    if (yPosition > 250) {
                        doc.addPage();
                        yPosition = 30;
                    }
                    
                    doc.setFontSize(14);
                    doc.text(`${document.codigo} - ${document.titulo}`, 20, yPosition);
                    yPosition += 10;
                    
                    doc.setFontSize(10);
                    doc.text(`Autor: ${document.autor || 'N/A'}`, 20, yPosition);
                    yPosition += 7;
                    
                    if (document.descricao) {
                        const lines = doc.splitTextToSize(document.descricao, 170);
                        doc.text(lines, 20, yPosition);
                        yPosition += lines.length * 5;
                    }
                    
                    yPosition += 10;
                });
                
                doc.save('casos-de-uso.pdf');
                showNotification('PDF exportado com sucesso!', 'success');
            } catch (error) {
                console.error('Error exporting PDF:', error);
                showNotification('Erro ao exportar PDF', 'error');
            }
        };

        window.exportToExcel = function() {
            try {
                const ws = XLSX.utils.json_to_sheet(documents.map(doc => ({
                    'Código': doc.codigo,
                    'Título': doc.titulo,
                    'Autor': doc.autor || '',
                    'Responsável': doc.responsavel || '',
                    'Descrição': doc.descricao || '',
                    'Problema': doc.problema || '',
                    'Solução': doc.solucao || '',
                    'Status': doc.status || '',
                    'Data Criação': formatDate(doc.dataCriacao)
                })));
                
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Casos de Uso');
                XLSX.writeFile(wb, 'casos-de-uso.xlsx');
                
                showNotification('Excel exportado com sucesso!', 'success');
            } catch (error) {
                console.error('Error exporting Excel:', error);
                showNotification('Erro ao exportar Excel', 'error');
            }
        };

        window.exportToWord = function() {
            try {
                const { Document, Packer, Paragraph, TextRun, HeadingLevel } = docx;
                
                const doc = new Document({
                    sections: [{
                        properties: {},
                        children: [
                            new Paragraph({
                                text: "JM TECNOLOGIA - Casos de Uso",
                                heading: HeadingLevel.TITLE,
                            }),
                            ...documents.flatMap(document => [
                                new Paragraph({
                                    text: `${document.codigo} - ${document.titulo}`,
                                    heading: HeadingLevel.HEADING_1,
                                }),
                                new Paragraph({
                                    children: [
                                        new TextRun({
                                            text: `Autor: ${document.autor || 'N/A'}`,
                                            bold: true,
                                        }),
                                    ],
                                }),
                                new Paragraph({
                                    text: document.descricao || 'Sem descrição',
                                }),
                                new Paragraph({
                                    text: "",
                                }),
                            ])
                        ],
                    }],
                });
                
                Packer.toBlob(doc).then(blob => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'casos-de-uso.docx';
                    a.click();
                    URL.revokeObjectURL(url);
                });
                
                showNotification('Word exportado com sucesso!', 'success');
            } catch (error) {
                console.error('Error exporting Word:', error);
                showNotification('Erro ao exportar Word', 'error');
            }
        };

        window.exportToJSON = function() {
            try {
                const dataStr = JSON.stringify(documents, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'casos-de-uso.json';
                a.click();
                URL.revokeObjectURL(url);
                
                showNotification('JSON exportado com sucesso!', 'success');
            } catch (error) {
                console.error('Error exporting JSON:', error);
                showNotification('Erro ao exportar JSON', 'error');
            }
        };

        // Mariano Assistant
        window.askMariano = function() {
            const question = document.getElementById('marianoInput').value.trim();
            if (!question) {
                showNotification('Digite uma pergunta para o Mariano', 'warning');
                return;
            }
            
            const marianoContent = document.querySelector('.mariano-content p');
            marianoContent.innerHTML = '<div class="loading"><div class="spinner"></div> Mariano está pensando...</div>';
            
            setTimeout(() => {
                const response = getMarianoResponse(question);
                marianoContent.innerHTML = response;
                document.getElementById('marianoInput').value = '';
            }, 1500);
        };

        function getMarianoResponse(question) {
            const q = question.toLowerCase();
            
            if (q.includes('como') && (q.includes('criar') || q.includes('novo'))) {
                return 'Para criar um novo caso de uso, clique em "Criar" no menu superior. O sistema gerará automaticamente um código único (UC-XXX). Preencha os campos obrigatórios como título e descrição. Você também pode adicionar subtarefas e anexos!';
            }
            
            if (q.includes('código') || q.includes('numeração')) {
                return 'O sistema gera códigos automaticamente no formato UC-001, UC-002, etc. Cada documento recebe um número único e sequencial. As subtarefas seguem o padrão UC-001.1, UC-001.2, garantindo organização hierárquica.';
            }
            
            if (q.includes('anexo') || q.includes('arquivo')) {
                return 'Você pode anexar arquivos arrastando-os para a área de upload ou clicando para selecionar. Formatos suportados: PDF, DOC, DOCX, XLS, XLSX, PNG, JPG. Limite máximo de 10MB por arquivo. Os arquivos são salvos no Firebase Storage.';
            }
            
            if (q.includes('subtarefa') || q.includes('sub')) {
                return 'As subtarefas permitem dividir um caso de uso em partes menores. Clique em "Adicionar Subtarefa" no formulário. Cada subtarefa recebe numeração automática (UC-001.1, UC-001.2) e pode ter título e descrição próprios.';
            }
            
            if (q.includes('exportar') || q.includes('export')) {
                return 'Você pode exportar seus documentos em 4 formatos: PDF (para visualização), Excel (para análise), Word (para edição) e JSON (para backup). Use os botões de exportação na seção "Documentos".';
            }
            
            if (q.includes('buscar') || q.includes('pesquisar') || q.includes('filtro')) {
                return 'Use a barra de pesquisa para encontrar documentos por título, código, autor ou descrição. Você também pode filtrar por status (Ativo, Inativo, Concluído) usando o seletor ao lado da busca.';
            }
            
            if (q.includes('excluir') || q.includes('deletar')) {
                return 'Para excluir um documento, clique no ícone de lixeira na lista. Será solicitada uma senha de segurança. Senhas válidas começam com "josimar". ATENÇÃO: A exclusão é permanente e não pode ser desfeita!';
            }
            
            if (q.includes('login') || q.includes('acesso')) {
                return 'O sistema possui controle de acesso. Apenas usuários autorizados podem fazer login. Os emails autorizados são gerenciados no Firebase. Entre em contato com o administrador para solicitar acesso.';
            }
            
            if (q.includes('problema') || q.includes('erro')) {
                return 'Se encontrar problemas: 1) Verifique sua conexão (indicador no topo); 2) Recarregue a página; 3) Verifique se está logado; 4) Contate o suporte técnico. O sistema salva automaticamente no Firebase.';
            }
            
            return 'Olá! Sou o Mariano, seu assistente para casos de uso. Posso ajudar com: criação de documentos, numeração automática, subtarefas, anexos, exportação, busca e filtros. Faça uma pergunta específica sobre qualquer funcionalidade!';
        }

        // AI Assistant
        window.askAI = async function() {
            const question = document.getElementById('aiInput').value.trim();
            if (!question) {
                showNotification('Digite uma pergunta para o assistente IA', 'warning');
                return;
            }
            
            const aiContent = document.getElementById('aiContent');
            const askBtn = document.getElementById('askAIBtn');
            
            askBtn.disabled = true;
            askBtn.innerHTML = '<div class="spinner"></div>';
            
            // Add user message
            const userMessage = document.createElement('div');
            userMessage.style.cssText = 'background: rgba(0,102,255,0.1); padding: 0.5rem; border-radius: 5px; margin-bottom: 0.5rem; border-left: 3px solid var(--primary-color);';
            userMessage.innerHTML = `<strong>Você:</strong> ${question}`;
            aiContent.appendChild(userMessage);
            
            try {
                let response;
                
                if (genAI) {
                    // Use Gemini AI
                    const model = genAI.getGenerativeModel({ model: "gemini-pro" });
                    const prompt = `Como especialista em casos de uso e análise de sistemas, responda a seguinte pergunta de forma clara e prática: ${question}`;
                    
                    const result = await model.generateContent(prompt);
                    response = result.response.text();
                } else {
                    // Fallback response
                    response = getAIFallbackResponse(question);
                }
                
                // Add AI response
                const aiMessage = document.createElement('div');
                aiMessage.style.cssText = 'background: rgba(255,107,53,0.1); padding: 0.5rem; border-radius: 5px; margin-bottom: 0.5rem; border-left: 3px solid var(--accent-color);';
                aiMessage.innerHTML = `<strong>IA:</strong> ${response}`;
                aiContent.appendChild(aiMessage);
                
            } catch (error) {
                console.error('AI Error:', error);
                const errorMessage = document.createElement('div');
                errorMessage.style.cssText = 'background: rgba(255,71,87,0.1); padding: 0.5rem; border-radius: 5px; margin-bottom: 0.5rem; border-left: 3px solid var(--error-color);';
                errorMessage.innerHTML = `<strong>Erro:</strong> Não foi possível processar sua pergunta. Tente novamente.`;
                aiContent.appendChild(errorMessage);
            } finally {
                askBtn.disabled = false;
                askBtn.innerHTML = '<i class="fas fa-magic"></i>';
                document.getElementById('aiInput').value = '';
                aiContent.scrollTop = aiContent.scrollHeight;
            }
        };

        function getAIFallbackResponse(question) {
            const q = question.toLowerCase();
            
            if (q.includes('caso de uso') || q.includes('use case')) {
                return 'Um caso de uso descreve como um usuário interage com o sistema para alcançar um objetivo específico. Deve incluir: identificação, descrição, atores, pré-condições, fluxo principal, fluxos alternativos e pós-condições.';
            }
            
            if (q.includes('ator') || q.includes('stakeholder')) {
                return 'Atores são entidades externas que interagem com o sistema. Podem ser usuários finais, administradores, sistemas externos ou dispositivos. Identifique todos os atores relevantes para cada caso de uso.';
            }
            
            if (q.includes('fluxo') || q.includes('cenário')) {
                return 'O fluxo principal descreve o caminho ideal de interação. Fluxos alternativos cobrem variações válidas. Fluxos de exceção tratam erros e situações inesperadas. Mantenha cada passo claro e numerado.';
            }
            
            if (q.includes('requisito') || q.includes('funcional')) {
                return 'Casos de uso ajudam a identificar requisitos funcionais do sistema. Cada caso representa uma funcionalidade específica. Use-os para validar se o sistema atende às necessidades dos usuários.';
            }
            
            return 'Como assistente IA, posso ajudar com análise de casos de uso, identificação de requisitos, modelagem de processos e boas práticas de documentação. Faça perguntas mais específicas para respostas detalhadas.';
        }

        // Utility functions
        function formatDate(date) {
            if (!date) return 'N/A';
            
            let d;
            if (date.toDate) {
                d = date.toDate(); // Firestore Timestamp
            } else if (date instanceof Date) {
                d = date;
            } else {
                d = new Date(date);
            }
            
            return d.toLocaleDateString('pt-BR');
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        // Enter key handlers
        document.getElementById('marianoInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                askMariano();
            }
        });

        document.getElementById('aiInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                askAI();
            }
        });
    </script>
</body>
</html>

